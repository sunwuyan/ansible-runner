---

# packages -----------------------------------------------------------

# FreeBSD
- name: "packages: Install Ansible Runner FreeBSD packages"
  block:
    - name: "packages: Install Ansible Runner packages FreeBSD"
      pkgng:
        name: "{{ item.name }}"
      loop: "{{ ar_packages }}"
      register: result
      until: result is succeeded
      retries: "{{ freebsd_install_retries }}"
      delay: "{{ freebsd_install_delay }}"
    - name: "packages: Debug FreeBSD packages"
      when: ar_debug|bool
      debug:
        var: result
  when:
    - not ar_pip_install
    - ansible_os_family == "FreeBSD"
    - freebsd_install_method|lower == "packages"

- name: "packages: Install FreeBSD ports"
  block:
    - name: "packages: Install Ansible Runner ports FreeBSD"
      portinstall:
        name: "{{ item.name }}"
        use_packages: "{{ freebsd_use_packages }}"
      loop: "{{ ar_packages }}"
      register: result
      until: result is succeeded
      retries: "{{ freebsd_install_retries }}"
      delay: "{{ freebsd_install_delay }}"
    - name: "packages: Debug FreeBSD ports"
      when: ar_debug|bool
      debug:
        var: result
  when:
    - not ar_pip_install
    - ansible_os_family == "FreeBSD"
    - freebsd_install_method|lower == "ports"

# Linux
- name: "packages: Install Ansible Runner packages Linux"
  block:
    - name: "packages: Install Ansible Runner packages Linux"
      package:
        name: "{{ item.name }}"
      loop: "{{ ar_packages }}"
      register: result
      until: result is succeeded
      retries: "{{ linux_install_retries }}"
      delay: "{{ linux_install_delay }}"
    - name: "packages: Debug Linux"
      when: ar_debug|bool
      debug:
        var: result
  when:
    - not ar_pip_install
    - ansible_os_family == "RedHat" or ansible_os_family == "Debian"

# pip ----------------------------------------------------------------
- name: "packages: Test {{ ar_pip_executable }} exists"
  when: ar_pip_install
  block:
    - name: "packages: Stat {{ ar_pip_executable }}"
      stat:
        path: "{{ ar_pip_executable }}"
      register: result
    - name: "packages: Not exists {{ ar_pip_executable }}"
      when: not result.stat.exists
      debug:
        msg: "[ERROR] {{ ar_pip_executable }} does not exist. End of host."
    - name: "packages: Meta end host"
      when: not result.stat.exists
      meta: end_host

- name: "packages: Install Ansible Runner pip packages for {{ ar_owner }}"
  when: ar_pip_install
  become_user: "{{ ar_owner }}"
  become: true
  changed_when: false  # Note 1.
  pip:
    name: "{{ item.name }}"
    executable: "{{ ar_pip_executable }}"
    version: "{{ item.version|default(omit) }}"
    state: "{{ item.state|default(omit) }}"
    extra_args: "{{ pip_extraagrs|default(omit) }}"
  loop: "{{ ar_packages }}"
  register: result
  until: result is succeeded
  retries: "{{ pip_install_retries }}"
  delay: "{{ pip_install_delay }}"

- name: "packages: Debug pip packages"
  when:
    - ar_pip_install
    - ar_debug|bool
  debug:
    var: result

- name: "packages: Install Ansible Runner pip requirements for {{ ar_owner }}"
  when:
    - ar_pip_install
    - ar_pip_requirements is defined
  become_user: "{{ ar_owner }}"
  become: true
  changed_when: false  # Note 1.
  pip:
    requirements: "{{ ar_pip_requirements }}"
    executable: "{{ ar_pip_executable }}"
    extra_args: "{{ pip_extraagrs|default(omit) }}"
  register: result
  until: result is succeeded
  retries: "{{ pip_install_retries }}"
  delay: "{{ pip_install_delay }}"

- name: "packages: Debug pip requirements"
  when:
    - ar_pip_install
    - ar_debug|bool
  debug:
    var: result

# Note 1.
# The pip module isn't always idempotent #28952
# https://github.com/ansible/ansible/issues/28952

# EOF
...
